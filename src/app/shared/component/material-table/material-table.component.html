<table mat-table [dataSource]="processedData" multiTemplateDataRows  class="table bor-light  mobile-card-view-normaltable responsive color-table d-table table-cust tbl-sml">

    <!-- Approval Mode: Checkbox Column -->
    @if (mode === 'approval' || mode === 'finance-approval') {
    <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
            <input *ngIf="hasSelectableRows" type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll()" />
        </th>
        <td mat-cell *matCellDef="let row">
            <input *ngIf="row.ClaimStatusId !== 5" type="checkbox" [(ngModel)]="row.selected" (change)="onRowSelectionChange(row)" />
        </td>
    </ng-container>
    }

    <!-- Preview Mode: Serial Number Column -->
    <ng-container *ngIf="mode === 'preview'" matColumnDef="slNo">
        <th mat-header-cell *matHeaderCellDef>{{ slNoLabel }}</th>
        <td    mat-cell *matCellDef="let row">{{ row.slNo }}</td>
    </ng-container>

    <!-- Common Action Icons -->
    <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row">


            <i class="fa fa-calculator" [matTooltip]="'GL Code: ' + row?.GLCode" matTooltipPosition="above"
                [matTooltipDisabled]="!row?.GLCode"></i>&nbsp;
            <i class="fa fa-paperclip" (click)="showAttachments(row?.attachment)" matTooltip="Documents"
                matTooltipPosition="above" [ngClass]="{ 'disabled-icon': !row?.attachment?.length }"
                [matTooltipDisabled]="!row?.attachment?.length"></i>&nbsp;
            <i class="fa fa-credit-card" [matTooltip]="'Payment Type: ' + row?.PaymentMode"
                [matTooltipDisabled]="!row?.PaymentMode" matTooltipPosition="above"></i>
        
            <div class="icons-new">
<svg  (click)="showRemarks(row?.ExpenseRequestDetailId)" width="19" height="18" viewBox="0 0 19 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                                                    <path d="M6.64286 9.00522H12.3571M5.5 5.57441H13.5M7.21429 13.5714L9.5 17L11.7857 13.5714H16.3571C16.9891 13.5714 17.5 13.0606 17.5 12.4286V2.14286C17.5 1.51086 16.9891 1 16.3571 1H2.64286C2.01086 1 1.5 1.51086 1.5 2.14286V12.4286C1.5 13.0606 2.01086 13.5714 2.64286 13.5714H7.21429Z" stroke="black" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"></path>
                                                                                             </svg>


                                                                                             </div>

        </td>
    </ng-container>

    <!-- Dynamic Columns -->
    <ng-container *ngFor="let col of visibleTabelColumns" [matColumnDef]="col.name">
        <th mat-header-cell *matHeaderCellDef>{{ col.label }}</th>
        <td     mat-cell *matCellDef="let row">
            @if (col.controlType === 'input' && mode === 'finance-approval') {
            <input [type]="col.type" class="form-control" [(ngModel)]="row[col.name]" [readonly]="!col.isEditableInFinanceApproval" [disabled]="!row.selected || row.ClaimStatusId == 5"
                (keydown)="preventInvalidKeys($event)" (ngModelChange)="onApprovedAmountChange(row)"
                (blur)="onAmountBlur($event, row, col.name, col.decimalPrecision || 2); validateApprovedAmount(row)" min="0" max="9999999999"
                (input)="enforceLimit($event, row, col.name)" />
            } @else {
            @if (col.type == 'date') {
            {{ row[col.name] | globalDate }}
            } @else {
            @if(mode==="approval" && col.name === 'ApprovedAmount') {

            <input [type]="col.type" class="form-control" [(ngModel)]="row[col.name]" [readonly]="!col.isEditableInApproval" [disabled]="!row.selected || row.ClaimStatusId == 5"
                (keydown)="preventInvalidKeys($event)" (ngModelChange)="onApprovedAmountChange(row)"
                (blur)="onAmountBlur($event, row, col.name, col.decimalPrecision || 2); validateApprovedAmount(row)" min="0" max="9999999999"
                (input)="enforceLimit($event, row, col.name)" />
            }@else{
            {{ row[col.name] }}
            }
            <!-- {{ row[col.name] }} -->
            }
            }
        </td>
    </ng-container>

    <!-- Expand Button Column -->
    <ng-container matColumnDef="expand">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row">
            <div class="icons-new">
                <i *ngIf="row?.IsViolation" class="fa fa-exclamation-triangle violation-icon"
                    [matTooltip]="row?.Violation" matTooltipPosition="above"></i>
                <span class="btn btn-showhide" (click)="toggleRow(row)">
                    <i [ngClass]="isExpanded(row) ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </span>
            </div>
        </td>
    </ng-container>

    <!-- Header Row -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

    <!-- Data Row -->
    <tr mat-row *matRowDef="let row; columns: displayedColumns" [ngClass]="{
          'violation-row': row?.IsViolation,
          'disabled-row': row?.ClaimStatusId == 5
        }">
        <pre>{{row |json}}</pre>
    </tr>


    <!-- Approval Mode: Remarks Row -->
    @if (mode === 'approval' || mode === 'finance-approval') {
    <tr mat-row *matRowDef="let row; columns: ['remarksRow']" class="remarks-row"></tr>
    }

    <!-- Expanded Detail Row -->
    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>

    <!-- Detail Row Template -->
    <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
            <div *ngIf="isExpanded(row)" class="expanded-container">
                @if (mode === 'finance-approval') {
                <app-add-gst [categoryGST]="categoryGST" [ExpenseRequestDetailId]="row?.ExpenseRequestDetailId"
                    [gstData]="row?.gst" [amount]="row?.ApprovedAmount"></app-add-gst>
                }

                @if (mode !== 'finance-approval') {
                <ng-container *ngFor="let nested of nestedTables">
                    @if (row[nested.dataKey]?.length) {
                    <table mat-table [dataSource]="row[nested.dataKey]" class="sub-table">
                        <ng-container *ngFor="let col of nested.columns" [matColumnDef]="col.name">
                            <th mat-header-cell *matHeaderCellDef>{{ col.label }}</th>
                            <td mat-cell *matCellDef="let entry">{{ entry[col.name] }}</td>
                        </ng-container>
                        <tr mat-header-row *matHeaderRowDef="getNestedColumnKeys(nested.columns)"></tr>
                        <tr mat-row *matRowDef="let entry; columns: getNestedColumnKeys(nested.columns)"></tr>
                    </table>
                    }
                </ng-container>
                }

                  <div class="row">

                    
                  <ng-container *ngFor="let col of visibleOtherColumns">
                        <div class="col-md-4 col-sm-4 col-lg-4 col-6" > 
                                     <div class="trl-preview-wrapper"> 
                                          <div class="trl-readview-item">                                                    
                        @if (col.type == 'date') {
                          <div class="trl-req-head">  <label> {{ col.label }} </label></div>  <div class="trl-req-detail"> <p> {{ row[col.name] | globalDate }} </p></div> 
                        } @else {
                           <div class="trl-req-head"> <label>  {{ col.label }} </label> </div>  <div class="trl-req-detail">  <p> {{ row[col.name] }} </p> </div> 
                        }
                          </div></div>  </div>    
                    </ng-container>


                </div>
 
            </div>
        </td>
    </ng-container>

    <!-- Remarks Full Width Row -->
    <!-- <ng-container matColumnDef="remarksRow">
        <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
            <div class="remarks-container">
                <label class="remarks-label">Remarks</label>
                <textarea [(ngModel)]="row.remarks" class="form-control" rows="2"></textarea>
            </div>
        </td>
    </ng-container> -->

    <!-- Remarks Full Width Row -->
    <ng-container matColumnDef="remarksRow">
        <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
            <div *ngIf="row.ClaimStatusId !== 5" class="remarks-container"
                [ngClass]="{ 'remarks-error': isRemarkInvalid(row) }">
                <label class="remarks-label">Remarks</label>
                <textarea [(ngModel)]="row.remarks" class="form-control" rows="2" maxlength="500"></textarea>
            </div>
        </td>
    </ng-container>

</table>